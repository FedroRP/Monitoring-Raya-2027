<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONITORING RAYA 2027</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Bar Animation */
        .bar-transition { transition: width 1s ease-in-out; }
        
        /* Tooltip Animation */
        .tooltip-anim { animation: tooltipFade 0.2s ease-out; }
        @keyframes tooltipFade { from { opacity: 0; transform: translate(-50%, 5px); } to { opacity: 1; transform: translate(-50%, 0); } }

        /* Modal Animation */
        .modal-enter-active { animation: modalFadeIn 0.2s ease-out forwards; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- ICON COMPONENTS ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            LayoutDashboard: (props) => <IconWrapper {...props}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconWrapper>,
            BarChart2: (props) => <IconWrapper {...props}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></IconWrapper>,
            List: (props) => <IconWrapper {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconWrapper>,
            Wallet: (props) => <IconWrapper {...props}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></IconWrapper>,
            CheckCircle: (props) => <IconWrapper {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></IconWrapper>,
            AlertTriangle: (props) => <IconWrapper {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconWrapper>,
            Clock: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconWrapper>,
            AlertOctagon: (props) => <IconWrapper {...props}><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>,
            TrendingUp: (props) => <IconWrapper {...props}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconWrapper>,
            Lightbulb: (props) => <IconWrapper {...props}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5 0-3-2.5-5-5-5s-5 2-5 5c0 1.5.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></IconWrapper>,
            Coins: (props) => <IconWrapper {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7 .71-2.82 2.82"/></IconWrapper>,
            Save: (props) => <IconWrapper {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            Trash2: (props) => <IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>,
            CheckSquare: (props) => <IconWrapper {...props}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconWrapper>,
            Square: (props) => <IconWrapper {...props}><rect width="18" height="18" x="3" y="3" rx="2"/></IconWrapper>,
            Hourglass: (props) => <IconWrapper {...props}><path d="M5 22h14"/><path d="M5 2h14"/><path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22"/><path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2"/></IconWrapper>,
            Filter: (props) => <IconWrapper {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconWrapper>,
            X: (props) => <IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>,
            RefreshCw: (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>,
            History: (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconWrapper>,
            Tag: (props) => <IconWrapper {...props}><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></IconWrapper>,
            Calculator: (props) => <IconWrapper {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>,
            Search: (props) => <IconWrapper {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconWrapper>,
            Info: (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconWrapper>,
            Edit: (props) => <IconWrapper {...props}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></IconWrapper>,
            Plus: (props) => <IconWrapper {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>
        };

        // --- CONFIGURATION ---
        const SERIES_CONFIG = [
            { 
                id: 1, 
                name: "Series 1", 
                launchDate: "2027-01-04", 
                schedule: [ 
                    { id: 1, start: "2026-06-01", end: "2026-06-14", leadTime: 14 },
                    { id: 2, start: "2026-06-15", end: "2026-06-19", leadTime: 5 },
                    { id: 3, start: "2026-06-15", end: "2026-06-19", leadTime: 5 },
                    { id: 4, start: "2026-06-20", end: "2026-06-24", leadTime: 5 },
                    { id: 5, start: "2026-06-25", end: "2026-06-29", leadTime: 5 },
                    { id: 6, start: "2026-06-30", end: "2026-07-06", leadTime: 7 },
                    { id: 7, start: "2026-07-07", end: "2026-09-11", leadTime: 67 },
                    { id: 8, start: "2026-07-07", end: "2026-08-20", leadTime: 45 },
                    { id: 9, start: "2026-08-14", end: "2026-08-27", leadTime: 14 },
                    { id: 10, start: "2026-08-28", end: "2026-09-11", leadTime: 15 },
                    { id: 11, start: "2026-09-12", end: "2026-11-17", leadTime: 67 },
                    { id: 12, start: "2026-11-18", end: "2026-11-22", leadTime: 5 },
                    { id: 13, start: "2026-11-18", end: "2026-11-27", leadTime: 10 },
                    { id: 14, start: "2026-11-23", end: "2026-12-07", leadTime: 15 }
                ] 
            },
            { 
                id: 2, 
                name: "Series 2", 
                launchDate: "2027-01-11", 
                schedule: [ 
                    { id: 1, start: "2026-06-15", end: "2026-06-29", leadTime: 15 },
                    { id: 2, start: "2026-06-30", end: "2026-07-04", leadTime: 5 },
                    { id: 3, start: "2026-06-30", end: "2026-07-04", leadTime: 5 },
                    { id: 4, start: "2026-07-05", end: "2026-07-09", leadTime: 5 },
                    { id: 5, start: "2026-07-10", end: "2026-07-14", leadTime: 5 },
                    { id: 6, start: "2026-07-15", end: "2026-07-21", leadTime: 7 },
                    { id: 7, start: "2026-07-22", end: "2026-09-26", leadTime: 67 },
                    { id: 8, start: "2026-07-22", end: "2026-09-04", leadTime: 45 },
                    { id: 9, start: "2026-08-29", end: "2026-09-11", leadTime: 14 },
                    { id: 10, start: "2026-09-12", end: "2026-09-26", leadTime: 15 },
                    { id: 11, start: "2026-09-27", end: "2026-12-02", leadTime: 67 },
                    { id: 12, start: "2026-12-03", end: "2026-12-07", leadTime: 5 },
                    { id: 13, start: "2026-12-03", end: "2026-12-12", leadTime: 10 },
                    { id: 14, start: "2026-12-12", end: "2026-12-26", leadTime: 15 } 
                ] 
            },
            { 
                id: 3, 
                name: "Series 3", 
                launchDate: "2027-01-18", 
                schedule: [ 
                    { id: 1, start: "2026-07-01", end: "2026-07-14", leadTime: 14 },
                    { id: 2, start: "2026-07-15", end: "2026-07-19", leadTime: 5 },
                    { id: 3, start: "2026-07-15", end: "2026-07-19", leadTime: 5 },
                    { id: 4, start: "2026-07-20", end: "2026-07-24", leadTime: 5 },
                    { id: 5, start: "2026-07-25", end: "2026-07-29", leadTime: 5 },
                    { id: 6, start: "2026-07-30", end: "2026-08-05", leadTime: 7 },
                    { id: 7, start: "2026-08-06", end: "2026-09-11", leadTime: 37 },
                    { id: 8, start: "2026-08-06", end: "2026-09-19", leadTime: 45 },
                    { id: 9, start: "2026-09-13", end: "2026-09-26", leadTime: 14 },
                    { id: 10, start: "2026-09-27", end: "2026-10-11", leadTime: 15 },
                    { id: 11, start: "2026-10-12", end: "2026-12-17", leadTime: 67 },
                    { id: 12, start: "2026-12-18", end: "2026-12-22", leadTime: 5 },
                    { id: 13, start: "2026-12-18", end: "2026-12-27", leadTime: 10 },
                    { id: 14, start: "2026-12-27", end: "2027-01-08", leadTime: 13 } 
                ] 
            },
            { 
                id: 4, 
                name: "Series 4", 
                launchDate: "2027-01-25", 
                schedule: [ 
                    { id: 1, start: "2026-07-15", end: "2026-07-29", leadTime: 15 },
                    { id: 2, start: "2026-07-30", end: "2026-08-03", leadTime: 5 },
                    { id: 3, start: "2026-07-30", end: "2026-08-03", leadTime: 5 },
                    { id: 4, start: "2026-08-04", end: "2026-08-08", leadTime: 5 },
                    { id: 5, start: "2026-08-09", end: "2026-08-13", leadTime: 5 },
                    { id: 6, start: "2026-08-14", end: "2026-08-20", leadTime: 7 },
                    { id: 7, start: "2026-08-21", end: "2026-10-26", leadTime: 67 },
                    { id: 8, start: "2026-08-21", end: "2026-10-04", leadTime: 45 },
                    { id: 9, start: "2026-09-28", end: "2026-10-11", leadTime: 14 },
                    { id: 10, start: "2026-10-12", end: "2026-10-26", leadTime: 15 },
                    { id: 11, start: "2026-10-27", end: "2027-01-01", leadTime: 67 },
                    { id: 12, start: "2027-01-02", end: "2027-01-06", leadTime: 5 },
                    { id: 13, start: "2027-01-02", end: "2027-01-11", leadTime: 10 },
                    { id: 14, start: "2027-01-06", end: "2027-01-15", leadTime: 10 } 
                ] 
            },
            { 
                id: 5, 
                name: "Series 5", 
                launchDate: "2027-02-01", 
                schedule: [ 
                    { id: 1, start: "2026-08-01", end: "2026-08-14", leadTime: 14 },
                    { id: 2, start: "2026-08-15", end: "2026-08-19", leadTime: 5 },
                    { id: 3, start: "2026-08-15", end: "2026-08-19", leadTime: 5 },
                    { id: 4, start: "2026-08-20", end: "2026-08-24", leadTime: 5 },
                    { id: 5, start: "2026-08-25", end: "2026-08-29", leadTime: 5 },
                    { id: 6, start: "2026-08-30", end: "2026-09-05", leadTime: 7 },
                    { id: 7, start: "2026-09-06", end: "2026-11-11", leadTime: 67 },
                    { id: 8, start: "2026-09-06", end: "2026-10-20", leadTime: 45 },
                    { id: 9, start: "2026-10-14", end: "2026-10-27", leadTime: 14 },
                    { id: 10, start: "2026-10-28", end: "2026-11-11", leadTime: 15 },
                    { id: 11, start: "2026-11-12", end: "2027-01-17", leadTime: 67 },
                    { id: 12, start: "2027-01-18", end: "2027-01-22", leadTime: 5 },
                    { id: 13, start: "2027-01-18", end: "2027-01-22", leadTime: 5 },
                    { id: 14, start: "2027-01-23", end: "2027-01-24", leadTime: 2 } 
                ] 
            }
        ];

        const TASK_NAMES = [
            "Approval Design", "Approval Accessories", "Approval Bahan", "Approval Motif", "Approval Color", "Payment Paperworks",
            "Material Production - Fabric", "Material Procurement - Brocade", "Pre Production Sample", "Size Set", "Mass Production",
            "Inbound", "Photoshoot & Catalog", "Offline Distribution"
        ];

        const BRAND_TARGETS = {
            "HEYMALE": 57,
            "HEYLOCAL": 42,
            "BOONABOO": 44,
            "SHUWA": 42
        };

        const COMPETITOR_DB = {
            "Dress/Gamis Basic": { 
                price: 289000, 
                note: "Avg. Market: Heaven Lights (~289k), Vanilla Hijab (~269k)" 
            },
            "Dress/Gamis Premium": { 
                price: 875000, 
                note: "Avg. Market: Buttonscarves (~1.2M), Wearing Klamby (~895k)" 
            },
            "Scarf Printing": { 
                price: 335000, 
                note: "Avg. Market: Buttonscarves (~425k), Wearing Klamby (~335k)" 
            },
            "Scarf Polos": { 
                price: 149000, 
                note: "Avg. Market: Buttonscarves (~225k), Heaven Lights (~99k)" 
            },
            "Blouse/Tunic": { 
                price: 325000, 
                note: "Avg. Market: Wearing Klamby (~450k), Heaven Lights (~299k)" 
            },
            "Prayer Set/Mukena": { 
                price: 950000, 
                note: "Avg. Market: Buttonscarves (~1.5M), Wearing Klamby (~950k)" 
            },
            "Pants/Bawahan": { 
                price: 249000, 
                note: "Avg. Market: Heaven Lights (~249k), Wearing Klamby (~375k)" 
            },
            "Bag/Accessories": { 
                price: 650000, 
                note: "Avg. Market: Buttonscarves (~1.8M), Wearing Klamby (~650k)" 
            },
             "Sunglasses/Eyewear": {
                price: 375000, 
                note: "Avg. Market: Buttonscarves (~1.2M), Wearing Klamby (~350k)"
            },
            "Outer/Jacket": { 
                price: 495000, 
                note: "Avg. Market: Wearing Klamby (~650k), Heaven Lights (~399k)" 
            }
        };

        const TIMELINE_START = "2026-06-01";
        const TIMELINE_END = "2027-03-31";

        // --- HELPER FUNCTIONS ---
        const getDiffDays = (start, end) => {
            const date1 = new Date(start);
            const date2 = new Date(end);
            const diffTime = date2 - date1;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return "-";
            const options = { day: 'numeric', month: 'short', year: '2-digit' };
            return new Date(dateStr).toLocaleDateString('id-ID', options);
        };

        const addDays = (dateStr, days) => {
            const result = new Date(dateStr);
            result.setDate(result.getDate() + days);
            return result.toISOString().split('T')[0];
        };

        const subtractDays = (dateStr, days) => {
            const result = new Date(dateStr);
            result.setDate(result.getDate() - days);
            return result.toISOString().split('T')[0];
        };

        const parseDateLocal = (dateStr) => {
            if(!dateStr) return null;
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d);
        };

        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(number);
        };

        const getRecommendation = (taskName) => {
            if (taskName.includes("Approval")) return `Solusi ${taskName}: Eskalasi ke Manajemen/Owner, minta prioritas review, atau jadwalkan meeting darurat.`;
            if (taskName.includes("Pre Production") || taskName.includes("Size Set")) return `Solusi ${taskName}: Pastikan sample dikirim tepat waktu, gunakan kurir express jika antar kota/negara.`;
            if (taskName.includes("Payment")) return `Solusi ${taskName}: Follow up Finance segera, cek kelengkapan dokumen invoice/PO.`;
            if (taskName.includes("Fabric") || taskName.includes("Brocade") || taskName.includes("Material")) return `Solusi ${taskName}: Cek stok supplier lain, minta pengiriman parsial (split shipment), atau gunakan ekspedisi udara.`;
            if (taskName.includes("Mass Production")) return `Solusi ${taskName}: Tambah shift lembur (overtime), tambah manpower, atau sub-kon ke vendor jahit rekanan.`;
            if (taskName.includes("Inbound")) return `Solusi ${taskName}: Prioritaskan slot bongkar di gudang, tambah tenaga bantuan (helper) inbound.`;
            if (taskName.includes("Photoshoot")) return `Solusi ${taskName}: Gunakan sample yang ada (mockup), booking studio/fotografer alternatif.`;
            if (taskName.includes("Distribution")) return `Solusi ${taskName}: Gunakan logistik express/cargo udara, prioritaskan area dengan demand tertinggi.`;
            return `Solusi ${taskName}: Evaluasi ulang timeline dan koordinasi dengan PIC terkait.`;
        };

        const getMonths = (startDate, endDate) => {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const months = [];
            let current = new Date(start);
            current.setDate(1);
            while (current <= end) {
                months.push(new Date(current));
                current.setMonth(current.getMonth() + 1);
            }
            return months;
        };

        const calculateBarStyles = (startStr, endStr, totalStartStr, totalDurationMs) => {
            if (!startStr || !endStr) return null;
            const start = new Date(startStr).getTime();
            const end = new Date(endStr).getTime();
            const totalStart = new Date(totalStartStr).getTime();
            if (end < totalStart) return null;
            const left = ((start - totalStart) / totalDurationMs) * 100;
            const width = ((end - start) / totalDurationMs) * 100;
            return { left: `${Math.max(0, left)}%`, width: `${width}%` };
        };

        // --- DEFINISI MODAL DI LUAR APP UNTUK MENCEGAH RE-RENDER/KEDAP-KEDIP ---

        const ConfirmationModal = React.memo(({ config, onConfirm, onCancel }) => {
            if (!config.isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm transition-opacity modal-enter-active">
                    <div className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 transform transition-all scale-100">
                        <div className="flex items-center gap-3 mb-4">
                            <div className="p-2 bg-rose-100 text-rose-600 rounded-full">
                                <Icons.AlertTriangle size={24} />
                            </div>
                            <h3 className="text-lg font-bold text-slate-800">Konfirmasi</h3>
                        </div>
                        <p className="text-slate-600 mb-6">{config.message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Batal</button>
                            <button onClick={onConfirm} className="px-4 py-2 text-sm font-medium text-white bg-rose-600 hover:bg-rose-700 rounded-lg shadow-sm transition-colors">Ya, Lanjutkan</button>
                        </div>
                    </div>
                </div>
            );
        });

        const AddTaskModal = React.memo(({ isOpen, onClose, onSave }) => {
            if (!isOpen) return null;
            
            const [form, setForm] = useState({
                name: '',
                planStart: '',
                planEnd: '',
                leadTime: 0
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setForm(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = () => {
                onSave(form);
                setForm({ name: '', planStart: '', planEnd: '', leadTime: 0 }); // Reset form
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm transition-opacity modal-enter-active">
                    <div className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 transform transition-all scale-100">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-bold text-slate-800">Tambah Aktivitas Baru</h3>
                            <button onClick={onClose}><Icons.X size={20} className="text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        <div className="space-y-3">
                            <div>
                                <label className="block text-xs font-medium text-slate-500 mb-1">Nama Aktivitas</label>
                                <input type="text" name="name" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={form.name} onChange={handleChange} placeholder="Contoh: Packing" />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-slate-500 mb-1">Plan Start</label>
                                <input type="date" name="planStart" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={form.planStart} onChange={handleChange} />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-slate-500 mb-1">Plan End</label>
                                <input type="date" name="planEnd" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={form.planEnd} onChange={handleChange} />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-slate-500 mb-1">Lead Time (Hari)</label>
                                <input type="number" name="leadTime" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={form.leadTime} onChange={handleChange} placeholder="0" />
                            </div>
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Batal</button>
                            <button onClick={handleSubmit} disabled={!form.name} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-sm transition-colors disabled:opacity-50">Tambah</button>
                        </div>
                    </div>
                </div>
            );
        });

        const EditTaskModal = React.memo(({ config, onClose, onSave, onChange }) => {
            if (!config.isOpen) return null;
            const { data: taskData } = config;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm transition-opacity modal-enter-active">
                    <div className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 transform transition-all scale-100">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-bold text-slate-800">Edit Aktivitas</h3>
                            <button onClick={onClose}><Icons.X size={20} className="text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        <div className="space-y-3">
                            <div>
                                <label className="block text-xs font-medium text-slate-500 mb-1">Nama Aktivitas</label>
                                <input type="text" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={taskData.name} onChange={(e) => onChange('name', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-slate-500 mb-1">Plan Start</label>
                                <input type="date" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={taskData.planStart} onChange={(e) => onChange('planStart', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-slate-500 mb-1">Plan End</label>
                                <input type="date" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={taskData.planEnd} onChange={(e) => onChange('planEnd', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-slate-500 mb-1">Lead Time (Hari)</label>
                                <input type="number" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={taskData.leadTime} onChange={(e) => onChange('leadTime', parseInt(e.target.value) || 0)} />
                            </div>
                        </div>
                        <div className="flex justify-end gap-3 mt-6">
                            <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Batal</button>
                            <button onClick={onSave} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-sm transition-colors">Simpan</button>
                        </div>
                    </div>
                </div>
            );
        });

        // --- MAIN APP COMPONENT ---
        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [data, setData] = useState([]);
            const [isClient, setIsClient] = useState(false);
            const [projectStart, setProjectStart] = useState("");
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const [currentTime, setCurrentTime] = useState(new Date());

            // Modal State
            const [modalConfig, setModalConfig] = useState({ isOpen: false, message: '', onConfirm: null });
            
            // Edit Modal State
            const [editModalConfig, setEditModalConfig] = useState({ isOpen: false, seriesIndex: null, activityIndex: null, data: null });

            // Add Activity Modal State
            const [addModalConfig, setAddModalConfig] = useState({ isOpen: false, seriesIndex: null });

            // Budgeting State
            const [budgetList, setBudgetList] = useState([]);
            const [budgetForm, setBudgetForm] = useState({
                seriesId: '', vendor: '', totalAmount: '', top: 0, leadTime: '', paymentTerm: ''
            });

            // Pricing State
            const [pricingList, setPricingList] = useState([]);
            const [pricingForm, setPricingForm] = useState({
                seriesId: '', brand: 'HEYLOCAL', category: '', articleName: '', rspWeb: '', hpp: '', competitorPrice: '', platformFee: 17.5, marketingFee: 15, notes: '', manualPrice: ''
            });

            // Filters
            const [dpFilterMonth, setDpFilterMonth] = useState(""); 
            const [repaymentFilterMonth, setRepaymentFilterMonth] = useState("");

            // Setup Timeline Vars
            const timelineMonths = useMemo(() => getMonths(TIMELINE_START, TIMELINE_END), []);
            const timelineTotalDuration = new Date(TIMELINE_END).getTime() - new Date(TIMELINE_START).getTime();

            useEffect(() => {
                setIsClient(true);
                const timer = setInterval(() => { setCurrentTime(new Date()); }, 1000);
                
                let earliestStart = "2099-12-31";
                SERIES_CONFIG.forEach(series => {
                    series.schedule.forEach(sch => {
                        if (sch.start < earliestStart) earliestStart = sch.start;
                    });
                });
                setProjectStart(earliestStart);

                // Load Data
                const savedData = localStorage.getItem('planner_data_v2'); 
                const savedBudget = localStorage.getItem('planner_budget_v2'); 
                const savedPricing = localStorage.getItem('planner_pricing_v2'); 

                if (savedData) {
                    setData(JSON.parse(savedData));
                } else {
                    const initialData = SERIES_CONFIG.map((config) => {
                        const tasks = config.schedule.map((sch, index) => {
                            return {
                                id: index + 1,
                                name: TASK_NAMES[index],
                                leadTime: sch.leadTime,
                                planStart: sch.start,
                                planEnd: sch.end,
                                actualStart: "",
                                actualEnd: "",
                                status: "pending"
                            };
                        });
                        return { id: config.id, name: config.name, launchDate: config.launchDate, activities: tasks };
                    });
                    setData(initialData);
                }

                if (savedBudget) {
                    setBudgetList(JSON.parse(savedBudget));
                }
                if (savedPricing) {
                    setPricingList(JSON.parse(savedPricing));
                }
                
                setIsDataLoaded(true);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                if (isDataLoaded) localStorage.setItem('planner_data_v2', JSON.stringify(data));
            }, [data, isDataLoaded]);

            useEffect(() => {
                if (isDataLoaded) localStorage.setItem('planner_budget_v2', JSON.stringify(budgetList));
            }, [budgetList, isDataLoaded]);

             useEffect(() => {
                if (isDataLoaded) localStorage.setItem('planner_pricing_v2', JSON.stringify(pricingList));
            }, [pricingList, isDataLoaded]);

            // --- CUSTOM MODAL HANDLER ---
            const showConfirm = useCallback((message, action) => {
                setModalConfig({ isOpen: true, message, onConfirm: action });
            }, []);

            const handleConfirm = useCallback(() => {
                if (modalConfig.onConfirm) modalConfig.onConfirm();
                setModalConfig({ isOpen: false, message: '', onConfirm: null });
            }, [modalConfig]);

            const handleCancel = useCallback(() => {
                setModalConfig({ isOpen: false, message: '', onConfirm: null });
            }, []);

            // --- ADD MODAL HANDLERS ---
            const openAddActivity = useCallback((sIdx) => {
                setAddModalConfig({ isOpen: true, seriesIndex: sIdx });
            }, []);

            const closeAddActivity = useCallback(() => {
                setAddModalConfig({ isOpen: false, seriesIndex: null });
            }, []);

            const handleSaveNewActivity = useCallback((newActivityData) => {
                const { seriesIndex } = addModalConfig;
                if (seriesIndex === null) return;

                const newData = [...data];
                const seriesActivities = newData[seriesIndex].activities;
                
                // Generate ID
                const maxId = seriesActivities.reduce((max, act) => Math.max(max, act.id), 0);
                
                const newActivity = {
                    id: maxId + 1,
                    name: newActivityData.name,
                    planStart: newActivityData.planStart,
                    planEnd: newActivityData.planEnd,
                    leadTime: parseInt(newActivityData.leadTime) || 0,
                    actualStart: "",
                    actualEnd: "",
                    status: "pending"
                };

                newData[seriesIndex].activities.push(newActivity);
                setData(newData);
                closeAddActivity();
            }, [data, addModalConfig, closeAddActivity]);

            // --- EDIT MODAL HANDLERS ---
            const openEditActivity = useCallback((sIdx, aIdx) => {
                const activity = data[sIdx].activities[aIdx];
                setEditModalConfig({
                    isOpen: true,
                    seriesIndex: sIdx,
                    activityIndex: aIdx,
                    data: { ...activity }
                });
            }, [data]);

            const closeEditActivity = useCallback(() => {
                setEditModalConfig({ isOpen: false, seriesIndex: null, activityIndex: null, data: null });
            }, []);

            const saveEditActivity = useCallback(() => {
                const { seriesIndex, activityIndex, data: newData } = editModalConfig;
                if (seriesIndex !== null && activityIndex !== null && newData) {
                    const newSeriesData = [...data];
                    newSeriesData[seriesIndex].activities[activityIndex] = newData;
                    setData(newSeriesData);
                    closeEditActivity();
                }
            }, [data, editModalConfig, closeEditActivity]);

            const handleEditFormChange = useCallback((field, value) => {
                setEditModalConfig(prev => ({
                    ...prev,
                    data: { ...prev.data, [field]: value }
                }));
            }, []);

            const deleteActivity = useCallback((sIdx, aIdx) => {
                const newSeriesData = [...data];
                newSeriesData[sIdx].activities.splice(aIdx, 1);
                setData(newSeriesData);
            }, [data]);

            const confirmDeleteActivity = useCallback((sIdx, aIdx) => {
                showConfirm("Apakah Anda yakin ingin menghapus aktivitas ini?", () => deleteActivity(sIdx, aIdx));
            }, [showConfirm, deleteActivity]);


            // --- RESET LOGIC FUNCTIONS ---
            const resetGanttData = () => {
                const initialData = SERIES_CONFIG.map((config) => {
                    const tasks = config.schedule.map((sch, index) => {
                        return {
                            id: index + 1,
                            name: TASK_NAMES[index],
                            leadTime: sch.leadTime,
                            planStart: sch.start,
                            planEnd: sch.end,
                            actualStart: "",
                            actualEnd: "",
                            status: "pending"
                        };
                    });
                    return { id: config.id, name: config.name, launchDate: config.launchDate, activities: tasks };
                });
                setData(initialData);
                localStorage.setItem('planner_data_v2', JSON.stringify(initialData));
            };

            const resetBudgetingData = () => {
                setBudgetList([]);
                setBudgetForm({ seriesId: '', vendor: '', totalAmount: '', top: 0, leadTime: '', paymentTerm: '' });
                localStorage.removeItem('planner_budget_v2');
            };

            const resetPricingData = () => {
                setPricingList([]);
                setPricingForm({ seriesId: '', brand: 'HEYLOCAL', category: '', articleName: '', rspWeb: '', hpp: '', competitorPrice: '', platformFee: 17.5, marketingFee: 15, notes: '', manualPrice: '' });
                localStorage.removeItem('planner_pricing_v2');
            };

            // Wrapper functions to trigger modal
            const confirmResetGantt = () => showConfirm("Reset Gantt Chart? Semua tanggal aktual akan dihapus.", resetGanttData);
            const confirmResetActivities = () => showConfirm("Reset All Activities data?", resetGanttData); // Activities shares data with Gantt
            const confirmResetBudget = () => showConfirm("Reset Budgeting data? Semua data budget akan dihapus.", resetBudgetingData);
            const confirmResetPricing = () => showConfirm("Reset Pricing data? Semua strategi harga tersimpan akan dihapus.", resetPricingData);


            const handleUpdateActual = (seriesIndex, actIndex, field, value) => {
                const newData = [...data];
                newData[seriesIndex].activities[actIndex][field] = value;
                setData(newData);
            };

            const dpNominal = useMemo(() => {
                const amount = parseFloat(budgetForm.totalAmount) || 0;
                const percentage = parseInt(budgetForm.top) || 0;
                return amount * (percentage / 100);
            }, [budgetForm.totalAmount, budgetForm.top]);

            const settlementNominal = useMemo(() => {
                const amount = parseFloat(budgetForm.totalAmount) || 0;
                return amount - dpNominal;
            }, [budgetForm.totalAmount, dpNominal]);

            // --- PRICING LOGIC ---
            const pricingResult = useMemo(() => {
                const rspWeb = parseFloat(pricingForm.rspWeb) || 0;
                const hpp = parseFloat(pricingForm.hpp) || 0;
                const platformFeePct = parseFloat(pricingForm.platformFee) || 0;
                const marketingFeePct = parseFloat(pricingForm.marketingFee) || 0;
                const competitorPrice = parseFloat(pricingForm.competitorPrice) || 0;
                
                const brandTarget = BRAND_TARGETS[pricingForm.brand] || 0;
                const fixedCost = 0; 

                const webGmAbs = rspWeb - hpp - fixedCost;
                const webGmPct = rspWeb > 0 ? (webGmAbs / rspWeb) * 100 : 0;
                const isBelowTarget = webGmPct < brandTarget;

                const totalFeePct = platformFeePct + marketingFeePct;
                let rspMpRaw = 0;
                if ((1 - (totalFeePct/100)) > 0) {
                      rspMpRaw = rspWeb / (1 - (totalFeePct/100));
                }

                let rspMpSuggested = Math.ceil(rspMpRaw / 1000) * 1000;
                const remainder = rspMpSuggested % 10000;
                if (remainder !== 9000) {
                    rspMpSuggested = Math.ceil(rspMpSuggested / 10000) * 10000 - 1000; 
                    if (rspMpSuggested < rspMpRaw) rspMpSuggested += 10000;
                }
                
                const finalPrice = parseFloat(pricingForm.manualPrice) || rspMpSuggested;

                const mpFeeNominal = finalPrice * (totalFeePct/100);
                const mpNetReceived = finalPrice - mpFeeNominal;
                const mpGmAbs = mpNetReceived - hpp - fixedCost;
                const mpGmPct = finalPrice > 0 ? (mpGmAbs / finalPrice) * 100 : 0;
                const growth = finalPrice - rspWeb;

                const makePsychological = (val) => {
                    return Math.ceil(val / 10000) * 10000 - 1000;
                };

                let competitiveAnalysis = {
                    status: 'neutral',
                    message: 'Input harga kompetitor untuk analisa.',
                    gap: 0,
                    suggestedAction: null
                };

                if (competitorPrice > 0) {
                    const gap = rspMpSuggested - competitorPrice; 
                    
                    if (gap > 0) {
                        if (competitorPrice < rspWeb) {
                             const safeFloor = makePsychological(rspWeb * 1.05); 
                             competitiveAnalysis = {
                                status: 'danger',
                                message: `Harga kompetitor (Rp${competitorPrice.toLocaleString()}) lebih rendah dari RSP Web Anda (Rp${rspWeb.toLocaleString()}). Tidak aman untuk diikuti!`,
                                gap: gap,
                                suggestedAction: {
                                    label: "Gunakan Harga Tengah (RSP Web + Fee)",
                                    price: safeFloor
                                }
                            };
                        } else {
                            const prettyCompetitor = makePsychological(competitorPrice);
                            competitiveAnalysis = {
                                status: 'warning',
                                message: `Harga Ideal (Rp${rspMpSuggested.toLocaleString()}) lebih mahal dari kompetitor. Bisa turunkan sedikit, tapi jangan di bawah RSP Web.`,
                                gap: gap,
                                suggestedAction: {
                                    label: "Samakan dengan Kompetitor",
                                    price: prettyCompetitor
                                }
                            };
                        }

                    } else if (gap < 0) {
                        const prettyCompetitorMinus = makePsychological(competitorPrice - 1000);
                        competitiveAnalysis = {
                            status: 'good',
                            message: `Harga Ideal lebih murah Rp${Math.abs(gap).toLocaleString()} dari kompetitor. Peluang profit lebih tinggi!`,
                            gap: gap,
                            suggestedAction: {
                                label: "Naikkan Sedikit (Profit Boost)",
                                price: prettyCompetitorMinus 
                            }
                        };
                    } else {
                        competitiveAnalysis = {
                            status: 'neutral',
                            message: `Harga Ideal sama dengan kompetitor.`,
                            gap: 0,
                            suggestedAction: null
                        };
                    }
                }

                return { 
                    webGmPct, webGmAbs, isBelowTarget, 
                    rspMpRaw, rspMpSuggested, 
                    mpFeeNominal, mpGmAbs, mpGmPct, growth, brandTarget,
                    competitiveAnalysis, finalPrice
                };
            }, [pricingForm]);

            const handleCategoryChange = (e) => {
                const selectedCat = e.target.value;
                const compData = COMPETITOR_DB[selectedCat];
                setPricingForm(prev => ({
                    ...prev,
                    category: selectedCat,
                    competitorPrice: compData ? compData.price : '',
                    notes: compData ? `Auto-filled based on ${compData.note}` : ''
                }));
            };

            const handleSavePricing = () => {
                 if (!pricingForm.articleName || !pricingForm.rspWeb || !pricingForm.hpp) return;
                 const newItem = { 
                     id: Date.now(), 
                     ...pricingForm, 
                     finalPrice: pricingResult.finalPrice,
                     mpGmPct: pricingResult.mpGmPct,
                     mpGmAbs: pricingResult.mpGmAbs,
                     webGmPct: pricingResult.webGmPct, // Added webGmPct to save
                     date: new Date().toISOString().split('T')[0] 
                 };
                 setPricingList([newItem, ...pricingList]);
                 setPricingForm(prev => ({ 
                     ...prev, 
                     articleName: '', rspWeb: '', hpp: '', competitorPrice: '', manualPrice: '', notes: '', category: '' 
                 })); 
            };

            const handleDeletePricing = (id) => {
                setPricingList(pricingList.filter(item => item.id !== id));
            };

            // Budget Filters
            const uniqueDpMonths = useMemo(() => {
                const months = new Set();
                budgetList.forEach(item => { if (item.dpDate && item.dpDate !== '-') months.add(item.dpDate.substring(0, 7)); });
                return Array.from(months).sort();
            }, [budgetList]);

            const uniqueRepaymentMonths = useMemo(() => {
                const months = new Set();
                budgetList.forEach(item => { if (item.repaymentDate && item.repaymentDate !== '-') months.add(item.repaymentDate.substring(0, 7)); });
                return Array.from(months).sort();
            }, [budgetList]);

            const filteredBudgetList = useMemo(() => {
                return budgetList.filter(item => {
                    const dpMatch = !dpFilterMonth || (item.dpDate && item.dpDate.startsWith(dpFilterMonth));
                    const repaymentMatch = !repaymentFilterMonth || (item.repaymentDate && item.repaymentDate.startsWith(repaymentFilterMonth));
                    return dpMatch && repaymentMatch;
                });
            }, [budgetList, dpFilterMonth, repaymentFilterMonth]);

            const budgetStats = useMemo(() => {
                let budgetPlanning = 0; 
                let paidAmount = 0;      
                let outstandingAmount = 0; 
                const today = new Date();

                // USE FILTERED LIST for stats calculation as requested
                filteredBudgetList.forEach(item => {
                    if (item.paymentStatus === 'fully_paid') {
                        budgetPlanning += 0;
                        paidAmount += item.totalAmount;
                    } else if (item.paymentStatus === 'dp_paid') {
                        budgetPlanning += item.settlementNominal;
                        paidAmount += item.dpNominal;
                    } else {
                        budgetPlanning += item.totalAmount;
                        paidAmount += 0;
                    }

                    const dpDate = item.dpDate && item.dpDate !== '-' ? new Date(item.dpDate) : null;
                    const repaymentDate = item.repaymentDate && item.repaymentDate !== '-' ? new Date(item.repaymentDate) : null;

                    if (item.paymentStatus === 'unpaid') {
                        if (dpDate && today > dpDate) outstandingAmount += item.dpNominal;
                        if (repaymentDate && today > repaymentDate) outstandingAmount += item.settlementNominal;
                    } else if (item.paymentStatus === 'dp_paid') {
                        if (repaymentDate && today > repaymentDate) outstandingAmount += item.settlementNominal;
                    }
                });
                return { budgetPlanning, paidAmount, outstandingAmount };
            }, [filteredBudgetList]);

            const handleSaveBudget = () => {
                if (!budgetForm.vendor || !budgetForm.totalAmount || !budgetForm.seriesId) return;
                const selectedSeries = SERIES_CONFIG.find(s => s.name === budgetForm.seriesId);
                let dpDateCalculated = "-";
                let repaymentDateCalculated = "-";

                if (selectedSeries) {
                    const launchDate = selectedSeries.launchDate;
                    const lt = parseInt(budgetForm.leadTime) || 0;
                    const pt = parseInt(budgetForm.paymentTerm) || 0;
                    const baseDate = subtractDays(launchDate, 14);
                    dpDateCalculated = subtractDays(baseDate, lt);
                    repaymentDateCalculated = addDays(baseDate, pt);
                }

                const newItem = {
                    id: Date.now(),
                    series: budgetForm.seriesId,
                    vendor: budgetForm.vendor,
                    totalAmount: parseFloat(budgetForm.totalAmount),
                    top: parseInt(budgetForm.top),
                    leadTime: budgetForm.leadTime || '-',
                    paymentTerm: budgetForm.paymentTerm || '-',
                    dpNominal: dpNominal,
                    settlementNominal: settlementNominal,
                    dpDate: dpDateCalculated,
                    repaymentDate: repaymentDateCalculated,
                    date: new Date().toISOString().split('T')[0],
                    paymentStatus: 'unpaid'
                };
                setBudgetList([newItem, ...budgetList]);
                setBudgetForm({ seriesId: '', vendor: '', totalAmount: '', top: 0, leadTime: '', paymentTerm: '' });
            };

            const handleDeleteBudget = (id) => {
                setBudgetList(budgetList.filter(item => item.id !== id));
            };

            const handleCycleStatus = (id) => {
                setBudgetList(budgetList.map(item => {
                    if (item.id === id) {
                        if (item.paymentStatus === 'unpaid') return { ...item, paymentStatus: 'dp_paid' };
                        if (item.paymentStatus === 'dp_paid') return { ...item, paymentStatus: 'fully_paid' };
                        return { ...item, paymentStatus: 'unpaid' };
                    }
                    return item;
                }));
            };

            const renderStatusBadge = (status) => {
                switch (status) {
                    case 'fully_paid': return <span className="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-[10px] font-bold uppercase border border-emerald-200">Lunas</span>;
                    case 'dp_paid': return <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[10px] font-bold uppercase border border-blue-200">Sudah DP</span>;
                    default: return <span className="bg-slate-100 text-slate-500 px-2 py-1 rounded text-[10px] font-bold uppercase border border-slate-200">Belum</span>;
                }
            };

            const stats = useMemo(() => {
                let totalTasks = 0;
                let completed = 0;
                let delayed = 0;
                let onTrack = 0;
                let inProgress = 0;
                let delayedSeriesSummary = []; 
                let allRecommendations = [];

                data.forEach(series => {
                    let currentSeriesDelayed = 0;
                    series.activities.forEach(act => {
                        totalTasks++;
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        const planEndObj = new Date(act.planEnd);
                        const isDone = !!act.actualEnd;
                        const isStarted = !!act.actualStart;
                        const isDoneLate = isDone && new Date(act.actualEnd) > planEndObj;
                        const isPendingLate = !isDone && today > planEndObj;

                        if (isDoneLate || isPendingLate) {
                            delayed++;
                            currentSeriesDelayed++;
                            allRecommendations.push({
                                id: `${series.id}-${act.id}`,
                                seriesName: series.name,
                                message: getRecommendation(act.name)
                            });
                        } else if (act.actualEnd) {
                            completed++;
                        } else {
                            if (act.actualStart && !act.actualEnd) {
                                inProgress++;
                            }
                            onTrack++; 
                        }
                    });
                    if (currentSeriesDelayed > 0) delayedSeriesSummary.push(`${series.name} (${currentSeriesDelayed} item)`);
                });

                return { totalTasks, completed, delayed, onTrack, inProgress, delayedSeriesString: delayedSeriesSummary, allRecommendations };
            }, [data]);

            const completionRate = stats.totalTasks ? Math.round(((stats.completed + (stats.inProgress * 0.5)) / stats.totalTasks) * 100) : 0;

            // --- RENDER FUNCTIONS ---
            
            const renderDashboard = () => (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="bg-gradient-to-r from-slate-800 to-indigo-900 rounded-xl p-6 text-white shadow-lg mb-6">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div><h2 className="text-2xl font-bold mb-1">Production Monitor Raya 2027</h2><p className="text-indigo-200 text-sm">Target Launching: Jan - Feb 2027</p></div>
                            <div className="flex gap-4 text-center">
                                <div className="bg-white/10 px-4 py-2 rounded-lg backdrop-blur-sm border border-white/10"><p className="text-xs text-indigo-200 uppercase tracking-wide">Project Kickoff</p><p className="font-mono font-bold text-sm">{formatDate(projectStart)}</p></div>
                                <div className="bg-emerald-500/20 px-4 py-2 rounded-lg border border-emerald-500/30 backdrop-blur-sm"><p className="text-xs text-emerald-300 uppercase tracking-wide">Launch Period</p><p className="font-mono font-bold text-emerald-300 text-sm">{formatDate(SERIES_CONFIG[0].launchDate)} - {formatDate(SERIES_CONFIG[SERIES_CONFIG.length - 1].launchDate)}</p></div>
                            </div>
                        </div>
                    </div>

                    <div className={`rounded-xl p-6 shadow-sm border mb-8 flex flex-col md:flex-row items-start gap-4 transition-colors duration-500 ${stats.delayed > 0 ? 'bg-rose-50 border-rose-100' : 'bg-emerald-50 border-emerald-100'}`}>
                        <div className="flex items-start gap-4 w-full">
                            <div className={`p-3 rounded-full shadow-sm shrink-0 ${stats.delayed > 0 ? 'bg-rose-100 text-rose-600' : 'bg-emerald-100 text-emerald-600'}`}>
                                {stats.delayed > 0 ? <Icons.AlertOctagon size={28} /> : <Icons.TrendingUp size={28} />}
                            </div>
                            <div className="w-full">
                                <h3 className={`text-lg font-bold mb-1 ${stats.delayed > 0 ? 'text-rose-800' : 'text-emerald-800'}`}>{stats.delayed > 0 ? "Risiko Keterlambatan Terdeteksi" : "Produksi On Track"}</h3>
                                <p className={`text-sm mb-4 ${stats.delayed > 0 ? 'text-rose-700' : 'text-emerald-700'}`}>{stats.delayed > 0 ? `Terdapat total ${stats.delayed} aktivitas terlambat yang tersebar di: ${stats.delayedSeriesString.join(', ')}.` : "Seluruh aktivitas berjalan sesuai timeline. Tidak ada isu kritis saat ini."}</p>
                                {stats.delayed > 0 && stats.allRecommendations.length > 0 && (
                                    <div className="bg-white/60 rounded-lg p-4 border border-rose-200/50">
                                        <div className="flex items-center gap-2 mb-2 text-rose-800 font-semibold text-sm"><Icons.Lightbulb size={16} className="text-amber-500 fill-amber-500"/><span>Saran Tindakan Perbaikan:</span></div>
                                        <ul className="list-none space-y-2">{stats.allRecommendations.map((rec) => (<li key={rec.id} className="text-xs text-slate-700 font-medium flex gap-2 items-start"><span className="font-bold text-rose-600 shrink-0 mt-0.5">[{rec.seriesName}]</span><span>{rec.message}</span></li>))}</ul>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden group hover:border-indigo-100 transition-colors">
                            <div className="flex justify-between items-start mb-4"><div><p className="text-slate-500 text-sm font-medium">Total Progress</p><h3 className="text-4xl font-bold text-slate-800 mt-1">{completionRate}%</h3></div><div className="p-3 bg-indigo-50 rounded-lg text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-colors"><Icons.BarChart2 size={24} /></div></div>
                            <div className="w-full bg-slate-100 rounded-full h-2"><div className="bg-indigo-600 h-2 rounded-full transition-all duration-1000" style={{ width: `${completionRate}%` }}></div></div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 group hover:border-emerald-100 transition-colors">
                            <div className="flex justify-between items-start"><div><p className="text-slate-500 text-sm font-medium">Completed</p><h3 className="text-4xl font-bold text-emerald-600 mt-1">{stats.completed}</h3><p className="text-xs text-slate-400 mt-1">Tasks finished</p></div><div className="p-3 bg-emerald-50 rounded-lg text-emerald-600 group-hover:bg-emerald-600 group-hover:text-white transition-colors"><Icons.CheckCircle size={24} /></div></div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 group hover:border-rose-100 transition-colors">
                            <div className="flex justify-between items-start"><div><p className="text-slate-500 text-sm font-medium">Delayed</p><h3 className="text-4xl font-bold text-rose-500 mt-1">{stats.delayed}</h3><p className="text-xs text-slate-400 mt-1">Needs attention</p></div><div className="p-3 bg-rose-50 rounded-lg text-rose-500 group-hover:bg-rose-500 group-hover:text-white transition-colors"><Icons.AlertTriangle size={24} /></div></div>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="px-6 py-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center"><h3 className="font-bold text-slate-800">Series Status Overview</h3><span className="text-xs text-slate-500">Breakdown per series</span></div>
                        <div className="p-6">
                            <div className="grid grid-cols-1 gap-6">
                                {data.map((series) => {
                                    const seriesTotal = series.activities.length;
                                    let lateCount = 0;
                                    let onTimeCount = 0;
                                    let inProgressCount = 0;
                                    let pendingCount = 0;
                                    let accumulatedProgress = 0; 
                                    const today = new Date();
                                    today.setHours(0,0,0,0);
                                    
                                    series.activities.forEach(act => {
                                        const planEndObj = new Date(act.planEnd);
                                        const startObj = act.actualStart ? parseDateLocal(act.actualStart) : null;
                                        const isDoneLate = act.actualEnd && new Date(act.actualEnd) > planEndObj;
                                        const isPendingLate = !act.actualEnd && today > planEndObj;
                                        const isDoneOnTime = act.actualEnd && !isDoneLate;
                                        const isInProgress = act.actualStart && !act.actualEnd && !isPendingLate;

                                        if (isDoneLate || isPendingLate) {
                                            lateCount++;
                                        } else if (isDoneOnTime) {
                                            onTimeCount++;
                                        } else if (isInProgress) {
                                            inProgressCount++;
                                            if (startObj) {
                                                const endObj = new Date(act.planEnd);
                                                let totalDur = (endObj - startObj) / (1000 * 60 * 60 * 24);
                                                if (totalDur <= 0) totalDur = 1;
                                                const elapsed = (today - startObj) / (1000 * 60 * 60 * 24);
                                                let p = elapsed / totalDur;
                                                if (p < 0.1) p = 0.1; 
                                                if (p > 1) p = 1;
                                                accumulatedProgress += p;
                                            }
                                        } else {
                                            pendingCount++;
                                        }
                                    });

                                    // Logic correction for Pending
                                    pendingCount = seriesTotal - onTimeCount - lateCount - inProgressCount;
                                    
                                    const pOnTime = (onTimeCount / seriesTotal) * 100;
                                    const pLate = (lateCount / seriesTotal) * 100;
                                    const pInProgressWidth = (inProgressCount / seriesTotal) * 100;
                                    const pPending = (pendingCount / seriesTotal) * 100;
                                    const avgProgress = inProgressCount > 0 ? Math.round((accumulatedProgress / inProgressCount) * 100) : 0;

                                    return (
                                        <div key={series.id} className="group">
                                            <div className="flex justify-between items-center mb-2">
                                                <div className="flex items-center gap-2"><h4 className="font-bold text-slate-700">{series.name}</h4><span className="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded">Target: {formatDate(series.launchDate)}</span></div>
                                                <div className="flex items-center gap-3 text-xs font-semibold">
                                                    <span className="text-emerald-600">{onTimeCount} Done</span>
                                                    <span className="text-rose-600">{lateCount} Late</span>
                                                    <span className="text-blue-600">{inProgressCount} In Progress ({avgProgress}%)</span>
                                                    <span className="text-slate-400">{Math.max(0, pendingCount)} Pending</span>
                                                </div>
                                            </div>
                                            <div className="w-full bg-slate-100 rounded-full h-4 overflow-hidden flex bar-transition">
                                                <div className="bg-emerald-500 h-full flex items-center justify-center text-[9px] text-white font-bold" style={{ width: `${pOnTime}%` }} title={`On Time`}>{onTimeCount > 0 && onTimeCount}</div>
                                                <div className="bg-rose-500 h-full flex items-center justify-center text-[9px] text-white font-bold" style={{ width: `${pLate}%` }} title={`Late`}>{lateCount > 0 && lateCount}</div>
                                                <div className="bg-blue-500 h-full flex items-center justify-center text-[9px] text-white font-bold" style={{ width: `${pInProgressWidth}%` }} title={`In Progress`}>{inProgressCount > 0 && `${avgProgress}%`}</div>
                                                <div className="bg-slate-200 h-full flex items-center justify-center text-[9px] text-slate-500 font-bold" style={{ width: `${pPending}%` }} title={`Pending`}>{pendingCount > 0 && pendingCount}</div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderActivities = () => {
                const allActivities = [];
                data.forEach(s => {
                    s.activities.forEach(a => {
                        allActivities.push({ ...a, seriesName: s.name });
                    });
                });

                const overdue = allActivities.filter(a => {
                    const planEnd = new Date(a.planEnd);
                    const actualEnd = a.actualEnd ? new Date(a.actualEnd) : null;
                    const today = new Date();
                    const isDoneLate = actualEnd && actualEnd > planEnd;
                    const isPendingLate = !actualEnd && today > planEnd;
                    return isDoneLate || isPendingLate;
                });

                const completed = allActivities.filter(a => {
                    const planEnd = new Date(a.planEnd);
                    const actualEnd = a.actualEnd ? new Date(a.actualEnd) : null;
                    return actualEnd && actualEnd <= planEnd;
                });

                const upcoming = allActivities.filter(a => !a.actualEnd && new Date() <= new Date(a.planEnd)).sort((a,b) => new Date(a.planStart) - new Date(b.planStart));

                return (
                    <div className="space-y-8 pb-10">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-slate-800">Activities Overview</h2>
                            <button onClick={confirmResetActivities} className="px-3 py-1.5 text-xs font-medium bg-rose-50 text-rose-600 rounded-md hover:bg-rose-100 transition-colors flex items-center gap-1">
                                <Icons.RefreshCw size={12}/> Reset Activities
                            </button>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div className="bg-white rounded-xl shadow-sm border border-rose-100 overflow-hidden">
                                <div className="px-6 py-4 border-b border-rose-100 bg-rose-50 flex items-center gap-3">
                                    <Icons.AlertTriangle size={20} className="text-rose-600"/>
                                    <h3 className="font-bold text-rose-800">Attention Needed</h3>
                                </div>
                                <div className="divide-y divide-rose-50 max-h-[400px] overflow-auto">
                                    {overdue.length === 0 ? (
                                        <div className="p-12 text-center text-slate-400"><p>No overdue items.</p></div>
                                    ) : (
                                        overdue.map((item, idx) => {
                                            const isDone = !!item.actualEnd;
                                            return (
                                                <div key={idx} className="p-4 hover:bg-rose-50/50 transition-colors flex justify-between items-center">
                                                    <div>
                                                        <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-600 mb-1">{item.seriesName}</span>
                                                        <h4 className="font-medium text-slate-800">{item.name}</h4>
                                                        <div className="flex items-center gap-2 mt-1">
                                                            <span className="text-xs text-rose-500 font-medium">Plan: {formatDate(item.planEnd)}</span>
                                                            {isDone ? <span className="text-[10px] text-white bg-rose-500 px-1.5 rounded font-bold">Done Late</span> : <span className="text-[10px] text-rose-600 bg-rose-100 px-1.5 rounded font-bold">Pending Overdue</span>}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="px-6 py-4 border-b border-slate-200 bg-slate-50 flex items-center gap-3">
                                    <Icons.List size={20} className="text-slate-600"/>
                                    <h3 className="font-bold text-slate-800">Operational Queue</h3>
                                </div>
                                <div className="divide-y divide-slate-100 max-h-[400px] overflow-auto">
                                    {upcoming.map((item, idx) => (
                                        <div key={idx} className="p-4 hover:bg-slate-50 transition-colors flex justify-between items-center">
                                            <div>
                                                <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-600 mb-1">{item.seriesName}</span>
                                                <h4 className="font-medium text-slate-800">{item.name}</h4>
                                                <p className="text-xs text-slate-500 mt-1">Start: {formatDate(item.planStart)}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Completed History Section */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="px-6 py-4 border-b border-slate-200 bg-slate-50 flex items-center gap-3">
                                <Icons.History size={20} className="text-emerald-600"/>
                                <h3 className="font-bold text-slate-800">Completed History</h3>
                            </div>
                            <div className="p-0 overflow-auto max-h-[300px]">
                                {completed.length === 0 ? (
                                    <div className="p-8 text-center text-slate-400">No completed tasks yet.</div>
                                ) : (
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-50 text-slate-600 font-semibold border-b border-slate-200 sticky top-0">
                                            <tr>
                                                <th className="px-6 py-3">Series</th>
                                                <th className="px-6 py-3">Activity</th>
                                                <th className="px-6 py-3">Plan End</th>
                                                <th className="px-6 py-3">Actual End</th>
                                                <th className="px-6 py-3">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {completed.map((item, idx) => (
                                                <tr key={idx} className="hover:bg-slate-50">
                                                    <td className="px-6 py-3 font-medium text-slate-600">{item.seriesName}</td>
                                                    <td className="px-6 py-3 text-slate-800">{item.name}</td>
                                                    <td className="px-6 py-3 text-slate-500">{formatDate(item.planEnd)}</td>
                                                    <td className="px-6 py-3 text-slate-500">{formatDate(item.actualEnd)}</td>
                                                    <td className="px-6 py-3">
                                                        <span className="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-xs font-bold">On Time</span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const renderGantt = () => (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[85vh]">
                    <div className="px-6 py-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center shrink-0">
                        <div>
                            <h3 className="font-bold text-slate-800 text-lg">Master Schedule</h3>
                            <div className="flex items-center gap-2 mt-1">
                                <span className="text-xs text-slate-500">Timeline: Jun 2026 - Mar 2027</span>
                                <span className="text-slate-300">|</span>
                                <span className="text-xs font-mono font-medium text-blue-600 flex items-center gap-1">
                                    <Icons.Clock size={12}/>
                                    {currentTime.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                </span>
                            </div>
                        </div>
                        <div className="flex items-center gap-6 text-xs font-medium bg-white px-3 py-1.5 rounded-full border border-slate-200 shadow-sm">
                            <button onClick={confirmResetGantt} className="px-3 py-1 bg-rose-50 text-rose-600 rounded-md hover:bg-rose-100 transition-colors flex items-center gap-1"><Icons.RefreshCw size={12}/> Reset Schedule</button>
                            <div className="flex items-center gap-2"><span className="w-3 h-3 bg-slate-300 rounded-sm"></span> Plan</div>
                            <div className="flex items-center gap-2"><span className="w-3 h-3 bg-emerald-500 rounded-sm"></span> Actual (On Time)</div>
                            <div className="flex items-center gap-2"><span className="w-3 h-3 bg-rose-500 rounded-sm"></span> Actual (Late)</div>
                            <div className="flex items-center gap-2"><span className="w-3 h-3 bg-blue-500 rounded-sm"></span> Actual (On Progress)</div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-auto relative">
                        <table className="w-full text-sm text-left border-collapse table-fixed">
                            <thead className="bg-white text-slate-600 sticky top-0 z-30 shadow-md">
                                <tr className="h-12">
                                    <th className="w-[250px] px-4 border-b border-r border-slate-200 bg-slate-50 sticky left-0 z-40 align-middle font-bold text-slate-700">Activity Name</th>
                                    <th className="w-[85px] px-1 text-center border-b border-slate-200 bg-slate-50 align-middle text-xs font-semibold">Plan Start</th>
                                    <th className="w-[85px] px-1 text-center border-b border-r border-slate-200 bg-slate-50 align-middle text-xs font-semibold">Plan End</th>
                                    <th className="w-[50px] px-1 text-center border-b border-r border-slate-200 bg-slate-50 align-middle text-xs font-semibold">LT</th>
                                    <th className="w-[95px] px-1 text-center border-b border-slate-200 bg-blue-50/50 align-middle text-xs font-semibold text-blue-800">Act. Start</th>
                                    <th className="w-[95px] px-1 text-center border-b border-r border-slate-200 bg-blue-50/50 align-middle text-xs font-semibold text-blue-800">Act. End</th>
                                    {timelineMonths.map((date, idx) => (
                                        <th key={idx} colSpan="4" className="border-b border-r border-slate-200 bg-slate-50 text-center text-xs font-bold text-slate-700 uppercase min-w-[120px]">
                                            {date.toLocaleDateString('id-ID', { month: 'short', year: '2-digit' })}
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {data.map((series, sIdx) => (
                                    <React.Fragment key={series.id}>
                                        <tr className="bg-slate-800 text-white shadow-sm z-20 relative">
                                            <td className="px-4 py-2 sticky left-0 z-20 bg-slate-800 border-r border-slate-700 font-bold text-xs uppercase tracking-wider flex items-center h-10">
                                                {series.name}
                                                <button onClick={() => openAddActivity(sIdx)} className="ml-2 p-1 bg-slate-700 hover:bg-slate-600 rounded text-slate-300" title="Add Activity">
                                                    <Icons.Plus size={12}/>
                                                </button>
                                            </td>
                                            <td colSpan="5" className="px-2 text-xs text-right text-slate-300 h-10 align-middle border-r border-slate-700 bg-slate-800">
                                                Launch: {formatDate(series.launchDate)}
                                            </td>
                                            <td colSpan={timelineMonths.length * 4} className="bg-slate-800 h-10"></td>
                                        </tr>
                                        {series.activities.map((act, aIdx) => {
                                            const today = new Date();
                                            today.setHours(0,0,0,0);
                                            const planEndObj = new Date(act.planEnd);
                                            let effectiveActualEnd = act.actualEnd;
                                            
                                            if (act.actualStart && !act.actualEnd) {
                                                const startObj = parseDateLocal(act.actualStart);
                                                if (today >= startObj) {
                                                    effectiveActualEnd = today.toISOString().split('T')[0];
                                                } else {
                                                    effectiveActualEnd = act.actualStart; 
                                                }
                                            }

                                            let delay = 0;
                                            if (act.actualEnd) {
                                                const diff = getDiffDays(act.planEnd, act.actualEnd);
                                                if (diff > 0) delay = diff;
                                            } else if (today > planEndObj) {
                                                 delay = getDiffDays(act.planEnd, today.toISOString().split('T')[0]);
                                            }
                                            
                                            const isLate = delay > 0;
                                            const isDone = !!act.actualEnd;
                                            const isInProgress = act.actualStart && !act.actualEnd;

                                            let progressPercent = 0;
                                            if (isInProgress) {
                                                const start = parseDateLocal(act.actualStart);
                                                const end = new Date(act.planEnd);
                                                let totalDur = (end - start) / (1000 * 60 * 60 * 24);
                                                if(totalDur <= 0) totalDur = 1;
                                                const elapsed = (today - start) / (1000 * 60 * 60 * 24);
                                                progressPercent = Math.round((elapsed / totalDur) * 100);
                                                if (progressPercent < 0) progressPercent = 0;
                                                if (progressPercent > 100) progressPercent = 100;
                                            }

                                            const planStyle = calculateBarStyles(act.planStart, act.planEnd, TIMELINE_START, timelineTotalDuration);
                                            
                                            let visualActStart = act.actualStart;
                                            let visualActEnd = effectiveActualEnd;

                                            if (!visualActStart && today > planEndObj) {
                                                visualActStart = act.planEnd;
                                                visualActEnd = today.toISOString().split('T')[0];
                                            }

                                            const actStyle = calculateBarStyles(
                                                visualActStart, 
                                                visualActEnd, 
                                                TIMELINE_START, 
                                                timelineTotalDuration
                                            );

                                            return (
                                                <tr key={act.id} className="hover:bg-slate-50 transition-colors h-11 group/item border-b border-slate-50">
                                                    <td className="px-4 py-1 font-medium text-slate-700 border-r border-slate-200 sticky left-0 bg-white group-hover/item:bg-slate-50 z-10 text-xs">
                                                        <div className="flex justify-between items-center w-full">
                                                            <div className="flex items-center gap-2 truncate flex-1">
                                                                <span className="text-slate-400 text-[10px] min-w-[15px]">{act.id}.</span>
                                                                <span title={act.name} className="truncate">{act.name}</span>
                                                                {isInProgress && <span className="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse ml-1" title="In Progress"></span>}
                                                            </div>
                                                            <div className="hidden group-hover/item:flex gap-1 bg-white/80 pl-1">
                                                                <button onClick={() => openEditActivity(sIdx, aIdx)} className="p-1 text-slate-400 hover:text-blue-600 transition-colors rounded"><Icons.Edit size={12} /></button>
                                                                <button onClick={() => confirmDeleteActivity(sIdx, aIdx)} className="p-1 text-slate-400 hover:text-rose-600 transition-colors rounded"><Icons.Trash2 size={12} /></button>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td className="px-1 text-slate-500 text-[10px] text-center border-r border-slate-100 bg-slate-50/30">{formatDate(act.planStart)}</td>
                                                    <td className="px-1 text-slate-500 text-[10px] text-center border-r border-slate-200 bg-slate-50/30">{formatDate(act.planEnd)}</td>
                                                    <td className="px-1 text-slate-500 text-[10px] text-center border-r border-slate-200 bg-slate-50/30">{act.leadTime}</td>
                                                    <td className="px-1 py-1 bg-blue-50/10 border-r border-slate-100 text-center">
                                                        <input type="date" className="w-full text-[10px] p-1 border border-blue-100 rounded bg-white text-slate-700 focus:border-blue-500 focus:ring-1 focus:ring-blue-200 outline-none" value={act.actualStart} onChange={(e) => handleUpdateActual(sIdx, aIdx, 'actualStart', e.target.value)} />
                                                    </td>
                                                    <td className="px-1 py-1 bg-blue-50/10 border-r border-slate-200 text-center">
                                                        <input type="date" className={`w-full text-[10px] p-1 border rounded bg-white text-slate-700 focus:ring-1 outline-none ${isLate ? 'border-rose-300 text-rose-600' : 'border-blue-100'}`} value={act.actualEnd} onChange={(e) => handleUpdateActual(sIdx, aIdx, 'actualEnd', e.target.value)} />
                                                    </td>
                                                    <td colSpan={timelineMonths.length * 4} className="relative p-0 h-11 align-middle">
                                                        <div className="relative w-full h-full flex items-center">
                                                            <div className="absolute inset-0 flex w-full h-full pointer-events-none">
                                                                {timelineMonths.map((_, mIdx) => (
                                                                    <React.Fragment key={mIdx}>
                                                                        <div className="flex-1 border-r border-slate-100 h-full border-dashed"></div>
                                                                        <div className="flex-1 border-r border-slate-100 h-full border-dashed"></div>
                                                                        <div className="flex-1 border-r border-slate-100 h-full border-dashed"></div>
                                                                        <div className="flex-1 border-r border-slate-300 h-full"></div>
                                                                    </React.Fragment>
                                                                ))}
                                                            </div>
                                                            {planStyle && <div className="absolute h-3 bg-slate-300 rounded-sm top-2 opacity-60" style={planStyle} title={`Plan: ${formatDate(act.planStart)}`}></div>}
                                                            {actStyle && (
                                                                <div 
                                                                    className={`absolute h-2.5 rounded-sm shadow-sm top-5 border border-white/20 ${isLate ? 'bg-rose-500' : (isDone ? 'bg-emerald-500' : 'bg-blue-500')} flex items-center justify-center group/bar cursor-help`} 
                                                                    style={actStyle} 
                                                                >
                                                                    {isInProgress && !isLate && (
                                                                        <span className="text-[8px] text-white font-bold leading-none px-1 drop-shadow-md truncate">{progressPercent}%</span>
                                                                    )}
                                                                    {isLate && (
                                                                        <span className="text-[8px] text-white font-bold leading-none px-1 drop-shadow-md">!</span>
                                                                    )}

                                                                    {/* POPUP / TOOLTIP */}
                                                                    <div className="hidden group-hover/bar:block absolute bottom-full mb-1 left-1/2 -translate-x-1/2 z-50 w-max max-w-[200px]">
                                                                        <div className="bg-gray-900 text-white text-[10px] rounded-md py-1 px-2 shadow-xl border border-gray-700 relative">
                                                                            <div className="font-bold border-b border-gray-700 pb-0.5 mb-0.5">{isLate ? 'Terlambat' : (isDone ? 'Selesai' : 'Sedang Berjalan')}</div>
                                                                            <div>{formatDate(visualActStart)} - {formatDate(visualActEnd)}</div>
                                                                            {isInProgress && !isLate && <div className="text-blue-300 font-semibold mt-0.5">Progress: {progressPercent}%</div>}
                                                                            {isLate && <div className="text-rose-300 font-semibold mt-0.5">Telat: {delay} Hari</div>}
                                                                            {/* Arrow */}
                                                                            <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </React.Fragment>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            // --- RENDER BUDGETING ---
            const renderBudgeting = () => (
                <div className="max-w-6xl mx-auto space-y-8 animate-fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                            <div>
                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Budget Planning</p>
                                <p className="text-2xl font-bold text-slate-800 mt-1">{formatRupiah(budgetStats.budgetPlanning)}</p>
                                <p className="text-[10px] text-slate-400 mt-1">Sisa Anggaran</p>
                            </div>
                            <div className="p-3 bg-blue-50 text-blue-600 rounded-xl"><Icons.Wallet size={24}/></div>
                        </div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                            <div>
                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Paid Amount</p>
                                <p className="text-2xl font-bold text-emerald-600 mt-1">{formatRupiah(budgetStats.paidAmount)}</p>
                                <p className="text-[10px] text-slate-400 mt-1">Total Dibayar</p>
                            </div>
                            <div className="p-3 bg-emerald-50 text-emerald-600 rounded-xl"><Icons.CheckCircle size={24}/></div>
                        </div>
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                            <div>
                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Outstanding</p>
                                <p className="text-2xl font-bold text-rose-600 mt-1">{formatRupiah(budgetStats.outstandingAmount)}</p>
                                <p className="text-[10px] text-slate-400 mt-1">Jatuh Tempo (Telat)</p>
                            </div>
                            <div className="p-3 bg-rose-50 text-rose-600 rounded-xl"><Icons.AlertOctagon size={24}/></div>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="px-6 py-4 border-b border-slate-200 bg-slate-50 flex items-center gap-2">
                            <Icons.Wallet className="text-slate-600" size={20}/>
                            <h3 className="font-bold text-slate-800">Budgeting & Payment Calculator</h3>
                            <button onClick={confirmResetBudget} className="ml-auto px-3 py-1 bg-slate-100 text-slate-500 rounded-md hover:bg-slate-200 transition-colors text-xs font-medium">Reset Budget</button>
                        </div>
                        <div className="p-8">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Select Series</label>
                                        <select className="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none bg-white" value={budgetForm.seriesId} onChange={(e) => setBudgetForm({...budgetForm, seriesId: e.target.value})}>
                                            <option value="">-- Choose Series --</option>
                                            {SERIES_CONFIG.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Vendor Name</label>
                                        <input type="text" className="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" value={budgetForm.vendor} onChange={(e) => setBudgetForm({...budgetForm, vendor: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Total Amount (IDR)</label>
                                        <input type="number" className="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" value={budgetForm.totalAmount} onChange={(e) => setBudgetForm({...budgetForm, totalAmount: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-2">TOP (%)</label>
                                        <div className="grid grid-cols-5 gap-2">
                                            {[0, 10, 20, 30, 40, 50, 60, 70, 80, 90].map((val) => (
                                                <label key={val} className={`cursor-pointer border rounded-md px-1 py-2 text-center text-xs font-medium transition-all ${budgetForm.top === val ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200'}`}>
                                                    <input type="radio" name="top" value={val} className="hidden" checked={budgetForm.top === val} onChange={() => setBudgetForm({...budgetForm, top: val})} />
                                                    {val}%
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Lead Time (Hari)</label>
                                        <input type="number" className="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" value={budgetForm.leadTime} onChange={(e) => setBudgetForm({...budgetForm, leadTime: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Pelunasan H+</label>
                                        <input type="number" className="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" value={budgetForm.paymentTerm} onChange={(e) => setBudgetForm({...budgetForm, paymentTerm: e.target.value})} />
                                    </div>
                                </div>
                                <div className="flex flex-col justify-between bg-slate-50 p-6 rounded-xl border border-slate-100">
                                    <div>
                                        <h4 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">Calculation</h4>
                                        <div className="space-y-3 text-sm">
                                            <div className="flex justify-between"><span className="text-slate-500">Series</span><span className="font-medium text-slate-800">{budgetForm.seriesId || '-'}</span></div>
                                            <div className="flex justify-between"><span className="text-slate-500">Total</span><span className="font-medium text-slate-800">{formatRupiah(budgetForm.totalAmount || 0)}</span></div>
                                            <div className="flex justify-between"><span className="text-slate-500">TOP</span><span className="font-medium text-blue-600">{budgetForm.top}%</span></div>
                                            <div className="h-px bg-slate-200 my-2"></div>
                                            <div className="flex justify-between"><span className="text-slate-600 font-bold">DP</span><span className="text-xl font-bold text-slate-900">{formatRupiah(dpNominal)}</span></div>
                                            <div className="flex justify-between"><span className="text-slate-600 font-bold">Pelunasan</span><span className="text-xl font-bold text-emerald-600">{formatRupiah(settlementNominal)}</span></div>
                                        </div>
                                    </div>
                                    <button onClick={handleSaveBudget} disabled={!budgetForm.vendor || !budgetForm.totalAmount} className="mt-6 w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-800 disabled:opacity-50 flex items-center justify-center gap-2"><Icons.Save size={18}/> Save</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="px-6 py-4 border-b border-slate-200 bg-slate-50 flex items-center gap-2">
                            <Icons.Coins className="text-slate-600" size={20}/>
                            <h3 className="font-bold text-slate-800">Saved Budget Records</h3>
                        </div>
                        {budgetList.length === 0 ? <div className="p-12 text-center text-slate-400">No records.</div> : (
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 text-slate-600 font-semibold border-b border-slate-200">
                                        <tr>
                                            <th className="px-4 py-3 w-[140px] text-center">Status</th>
                                            <th className="px-4 py-3">Date</th>
                                            <th className="px-4 py-3">Series</th>
                                            <th className="px-4 py-3">Vendor</th>
                                            <th className="px-4 py-3 text-right">Total</th>
                                            <th className="px-4 py-3 text-center">TOP</th>
                                            <th className="px-4 py-3 text-center bg-blue-50/50">
                                                <div className="flex flex-col items-center gap-1">
                                                    <span>Jadwal DP</span>
                                                    <select className="text-[10px] border border-blue-200 rounded px-1" value={dpFilterMonth} onChange={(e) => setDpFilterMonth(e.target.value)}>
                                                        <option value="">All</option>
                                                        {uniqueDpMonths.map(m => <option key={m} value={m}>{new Date(m + "-01").toLocaleDateString('id-ID', {month: 'short', year: '2-digit'})}</option>)}
                                                    </select>
                                                </div>
                                            </th>
                                            <th className="px-4 py-3 text-right text-blue-700 bg-blue-50/30">Nominal DP</th>
                                            <th className="px-4 py-3 text-center bg-emerald-50/50">
                                                <div className="flex flex-col items-center gap-1">
                                                    <span>Jadwal Pelunasan</span>
                                                    <select className="text-[10px] border border-emerald-200 rounded px-1" value={repaymentFilterMonth} onChange={(e) => setRepaymentFilterMonth(e.target.value)}>
                                                        <option value="">All</option>
                                                        {uniqueRepaymentMonths.map(m => <option key={m} value={m}>{new Date(m + "-01").toLocaleDateString('id-ID', {month: 'short', year: '2-digit'})}</option>)}
                                                    </select>
                                                </div>
                                            </th>
                                            <th className="px-4 py-3 text-right text-emerald-700 bg-emerald-50/30">Nominal Pelunasan</th>
                                            <th className="px-4 py-3 text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {filteredBudgetList.map((item) => (
                                            <tr key={item.id} className="hover:bg-slate-50 transition-colors">
                                                <td className="px-4 py-3 text-center">
                                                    <button onClick={() => handleCycleStatus(item.id)} className="focus:outline-none hover:scale-105 transition-transform">{renderStatusBadge(item.paymentStatus)}</button>
                                                </td>
                                                <td className="px-4 py-3 text-slate-500 text-xs">{item.date}</td>
                                                <td className="px-4 py-3 font-medium text-slate-800">{item.series}</td>
                                                <td className="px-4 py-3 font-medium text-slate-800">{item.vendor}</td>
                                                <td className="px-4 py-3 text-right text-slate-600">{formatRupiah(item.totalAmount)}</td>
                                                <td className="px-4 py-3 text-center"><span className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">{item.top}%</span></td>
                                                <td className="px-4 py-3 text-center bg-blue-50/30 text-blue-700 font-medium text-xs">{item.dpDate ? formatDate(item.dpDate) : '-'}</td>
                                                <td className="px-4 py-3 text-right font-bold text-blue-600 bg-blue-50/30">{formatRupiah(item.dpNominal)}</td>
                                                <td className="px-4 py-3 text-center bg-emerald-50/30 text-emerald-700 font-medium text-xs">{item.repaymentDate ? formatDate(item.repaymentDate) : '-'}</td>
                                                <td className="px-4 py-3 text-right font-bold text-emerald-600 bg-emerald-50/30">{formatRupiah(item.settlementNominal)}</td>
                                                <td className="px-4 py-3 text-center">
                                                    <button onClick={() => handleDeleteBudget(item.id)} className="text-rose-500 hover:text-rose-700"><Icons.Trash2 size={16}/></button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );

            // --- RENDER PRICING ---
            const renderPricing = () => (
                <div className="max-w-6xl mx-auto space-y-8 animate-fade-in">
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="px-6 py-4 border-b border-slate-200 bg-slate-50 flex items-center gap-2">
                            <Icons.Tag className="text-slate-600" size={20}/>
                            <h3 className="font-bold text-slate-800">RSP Marketplace Calculator</h3>
                            <button onClick={confirmResetPricing} className="ml-auto px-3 py-1 bg-slate-100 text-slate-500 rounded-md hover:bg-slate-200 transition-colors text-xs font-medium">Reset Pricing</button>
                        </div>
                        <div className="p-8">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Brand</label>
                                        <select className="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none bg-white" value={pricingForm.brand} onChange={(e) => setPricingForm({...pricingForm, brand: e.target.value})}>
                                            {Object.keys(BRAND_TARGETS).map(brand => <option key={brand} value={brand}>{brand} (Target: {BRAND_TARGETS[brand]}%)</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Kategori Produk</label>
                                        <select className="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none bg-white" value={pricingForm.category} onChange={handleCategoryChange}>
                                            <option value="">-- Pilih Kategori --</option>
                                            {Object.keys(COMPETITOR_DB).map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Nama Artikel / SKU</label>
                                        <input type="text" className="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Contoh: Dress Raya Series 1" value={pricingForm.articleName} onChange={(e) => setPricingForm({...pricingForm, articleName: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">RSP Web (Harga Jual Website)</label>
                                        <input type="number" className="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0" value={pricingForm.rspWeb} onChange={(e) => setPricingForm({...pricingForm, rspWeb: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">HPP (Harga Pokok Produksi)</label>
                                        <input type="number" className="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0" value={pricingForm.hpp} onChange={(e) => setPricingForm({...pricingForm, hpp: e.target.value})} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">Platform Fee (%)</label>
                                            <input type="number" className="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" value={pricingForm.platformFee} onChange={(e) => setPricingForm({...pricingForm, platformFee: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">Marketing Fee (%)</label>
                                            <input type="number" className="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none" value={pricingForm.marketingFee} onChange={(e) => setPricingForm({...pricingForm, marketingFee: e.target.value})} />
                                        </div>
                                    </div>
                                </div>

                                <div className="flex flex-col justify-between bg-slate-50 p-6 rounded-xl border border-slate-100">
                                    <div>
                                        <h4 className="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">Pricing Breakdown</h4>
                                        <div className="space-y-3 text-sm">
                                            <div className="flex justify-between items-center">
                                                <span className="text-slate-500">Web GM% (Target: {pricingResult.brandTarget}%)</span>
                                                <span className={`font-bold px-2 py-0.5 rounded text-xs ${pricingResult.isBelowTarget ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}`}>
                                                    {pricingResult.webGmPct.toFixed(2)}% {pricingResult.isBelowTarget && " Low"}
                                                </span>
                                            </div>
                                            <div className="flex justify-between"><span className="text-slate-500">Web GM Absolute</span><span className="font-medium text-slate-800">{formatRupiah(pricingResult.webGmAbs)}</span></div>
                                            <div className="h-px bg-slate-200 my-2"></div>
                                            
                                            <div className="flex flex-col gap-2 bg-white p-3 rounded border border-slate-200 shadow-sm mb-4">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-slate-600 font-bold text-xs">CALCULATED RSP</span>
                                                    <span className="text-sm font-mono text-slate-400">{formatRupiah(pricingResult.rspMpRaw)}</span>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <span className="text-indigo-600 font-bold text-lg">SUGGESTED RSP</span>
                                                    <span className="text-2xl font-bold text-indigo-600">{formatRupiah(pricingResult.rspMpSuggested)}</span>
                                                </div>
                                                <div className="text-[10px] text-slate-400 text-right italic">*Rounded for psychology pricing</div>
                                            </div>

                                            <div className="mb-4">
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-xs font-bold text-slate-500 uppercase">Cek Harga Kompetitor (Auto)</label>
                                                </div>
                                                <div className="flex gap-2">
                                                    <input type="number" className="w-full p-2 text-sm border border-slate-300 rounded-md focus:ring-1 focus:ring-blue-500 outline-none bg-slate-50" placeholder="Pilih kategori..." value={pricingForm.competitorPrice} onChange={(e) => setPricingForm({...pricingForm, competitorPrice: e.target.value})} />
                                                </div>
                                                
                                                {pricingResult.competitiveAnalysis.status !== 'neutral' && (
                                                    <div className={`mt-2 p-2 rounded border text-xs ${pricingResult.competitiveAnalysis.status === 'danger' ? 'bg-rose-50 border-rose-200 text-rose-700' : (pricingResult.competitiveAnalysis.status === 'warning' ? 'bg-amber-50 border-amber-200 text-amber-700' : 'bg-emerald-50 border-emerald-200 text-emerald-700')}`}>
                                                        <div className="font-bold flex items-center gap-1">
                                                            {pricingResult.competitiveAnalysis.status === 'danger' ? <Icons.AlertTriangle size={12}/> : (pricingResult.competitiveAnalysis.status === 'warning' ? <Icons.Info size={12}/> : <Icons.CheckCircle size={12}/>)}
                                                            Insight:
                                                        </div>
                                                        <div>{pricingResult.competitiveAnalysis.message}</div>
                                                        {pricingResult.competitiveAnalysis.suggestedAction && (
                                                            <div className="mt-1 pt-1 border-t border-black/10">
                                                                <div className="font-semibold">Rekomendasi: {pricingResult.competitiveAnalysis.suggestedAction.label} ({formatRupiah(pricingResult.competitiveAnalysis.suggestedAction.price)})</div>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>

                                            <div className="mb-4">
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Harga Final (Adjusted)</label>
                                                <input type="number" className="w-full p-2 border border-indigo-200 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none font-bold text-indigo-700" placeholder={pricingResult.rspMpSuggested} value={pricingForm.manualPrice} onChange={(e) => setPricingForm({...pricingForm, manualPrice: e.target.value})} />
                                                <div className="text-[10px] text-slate-400 mt-1 text-right">Edit jika ingin menyesuaikan harga manual</div>
                                            </div>
                                            
                                            <div className="text-xs text-slate-400 uppercase font-bold tracking-wider mb-2">Estimasi Potongan & Profit MP (Final)</div>
                                            <div className="flex justify-between"><span className="text-slate-500">Biaya Admin MP</span><span className="font-medium text-rose-500">-{formatRupiah(pricingResult.mpFeeNominal)}</span></div>
                                            <div className="flex justify-between"><span className="text-slate-500">Sisa Bersih (Net)</span><span className="font-bold text-slate-800">{formatRupiah(pricingResult.finalPrice - pricingResult.mpFeeNominal)}</span></div>
                                            <div className="flex justify-between"><span className="text-slate-500">MP GM Absolute</span><span className="font-bold text-emerald-600">{formatRupiah(pricingResult.mpGmAbs)}</span></div>
                                            <div className="flex justify-between"><span className="text-slate-500">MP GM %</span><span className="font-medium text-blue-600">{pricingResult.mpGmPct.toFixed(2)}%</span></div>
                                            <div className="flex justify-between mt-2 pt-2 border-t border-slate-200"><span className="text-slate-500 font-bold">Growth (MP - Web)</span><span className="font-bold text-indigo-600">+{formatRupiah(pricingResult.growth)}</span></div>
                                        </div>
                                    </div>
                                    <button onClick={handleSavePricing} disabled={!pricingForm.articleName || !pricingForm.rspWeb || !pricingForm.hpp} className="mt-6 w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-800 disabled:opacity-50 flex items-center justify-center gap-2"><Icons.Save size={18}/> Save to List</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="px-6 py-4 border-b border-slate-200 bg-slate-50 flex items-center gap-2">
                            <Icons.List className="text-slate-600" size={20}/>
                            <h3 className="font-bold text-slate-800">Saved Pricing Strategy</h3>
                        </div>
                        {pricingList.length === 0 ? <div className="p-12 text-center text-slate-400">No records saved yet.</div> : (
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 text-slate-600 font-semibold border-b border-slate-200">
                                        <tr>
                                            <th className="px-4 py-3">Article Name</th>
                                            <th className="px-4 py-3 text-center">Brand</th>
                                            <th className="px-4 py-3 text-right">RSP Web</th>
                                            <th className="px-4 py-3 text-right">Web GM</th>
                                            <th className="px-4 py-3 text-right">HPP</th>
                                            <th className="px-4 py-3 text-right font-bold text-indigo-600">RSP MP Final</th>
                                            <th className="px-4 py-3 text-right text-emerald-600">MP GM</th>
                                            <th className="px-4 py-3">Notes</th>
                                            <th className="px-4 py-3 text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {pricingList.map((item) => (
                                            <tr key={item.id} className="hover:bg-slate-50">
                                                <td className="px-4 py-3 font-medium text-slate-800">{item.articleName}</td>
                                                <td className="px-4 py-3 text-center text-xs font-bold text-slate-500 bg-slate-100 rounded">{item.brand}</td>
                                                <td className="px-4 py-3 text-right text-slate-600">{formatRupiah(item.rspWeb)}</td>
                                                <td className="px-4 py-3 text-right text-slate-500">{item.webGmPct ? item.webGmPct.toFixed(1) : 0}%</td>
                                                <td className="px-4 py-3 text-right text-slate-600">{formatRupiah(item.hpp)}</td>
                                                <td className="px-4 py-3 text-right font-bold text-indigo-600">{formatRupiah(item.finalPrice)}</td>
                                                <td className="px-4 py-3 text-right font-bold text-emerald-600">{item.mpGmPct.toFixed(1)}%</td>
                                                <td className="px-4 py-3 text-slate-500 italic max-w-xs truncate text-xs">{item.notes}</td>
                                                <td className="px-4 py-3 text-center">
                                                    <button onClick={() => handleDeletePricing(item.id)} className="text-rose-500 hover:text-rose-700"><Icons.Trash2 size={16}/></button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
            
            // --- Custom Modal ---
            const ConfirmationModal = ({ config, onConfirm, onCancel }) => {
                if (!config.isOpen) return null;
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm transition-opacity modal-enter-active">
                        <div className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 transform transition-all scale-100">
                            <div className="flex items-center gap-3 mb-4">
                                <div className="p-2 bg-rose-100 text-rose-600 rounded-full">
                                    <Icons.AlertTriangle size={24} />
                                </div>
                                <h3 className="text-lg font-bold text-slate-800">Konfirmasi</h3>
                            </div>
                            <p className="text-slate-600 mb-6">{config.message}</p>
                            <div className="flex justify-end gap-3">
                                <button onClick={onCancel} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Batal</button>
                                <button onClick={onConfirm} className="px-4 py-2 text-sm font-medium text-white bg-rose-600 hover:bg-rose-700 rounded-lg shadow-sm transition-colors">Ya, Lanjutkan</button>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- Add Task Modal ---
            const AddTaskModal = ({ isOpen, onClose, onSave }) => {
                if (!isOpen) return null;
                
                const [form, setForm] = useState({
                    name: '',
                    planStart: '',
                    planEnd: '',
                    leadTime: 0
                });

                const handleChange = (e) => {
                    const { name, value } = e.target;
                    setForm(prev => ({ ...prev, [name]: value }));
                };

                const handleSubmit = () => {
                    onSave(form);
                    setForm({ name: '', planStart: '', planEnd: '', leadTime: 0 }); // Reset form
                };

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm transition-opacity modal-enter-active">
                        <div className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 transform transition-all scale-100">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-bold text-slate-800">Tambah Aktivitas Baru</h3>
                                <button onClick={onClose}><Icons.X size={20} className="text-slate-400 hover:text-slate-600"/></button>
                            </div>
                            <div className="space-y-3">
                                <div>
                                    <label className="block text-xs font-medium text-slate-500 mb-1">Nama Aktivitas</label>
                                    <input type="text" name="name" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={form.name} onChange={handleChange} placeholder="Contoh: Packing" />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-slate-500 mb-1">Plan Start</label>
                                    <input type="date" name="planStart" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={form.planStart} onChange={handleChange} />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-slate-500 mb-1">Plan End</label>
                                    <input type="date" name="planEnd" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={form.planEnd} onChange={handleChange} />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-slate-500 mb-1">Lead Time (Hari)</label>
                                    <input type="number" name="leadTime" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={form.leadTime} onChange={handleChange} placeholder="0" />
                                </div>
                            </div>
                            <div className="flex justify-end gap-3 mt-6">
                                <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Batal</button>
                                <button onClick={handleSubmit} disabled={!form.name} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-sm transition-colors disabled:opacity-50">Tambah</button>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- Edit Task Modal ---
            const EditTaskModal = ({ config, onClose, onSave, onChange }) => {
                if (!config.isOpen) return null;
                const { data: taskData } = config;

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm transition-opacity modal-enter-active">
                        <div className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 transform transition-all scale-100">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-bold text-slate-800">Edit Aktivitas</h3>
                                <button onClick={onClose}><Icons.X size={20} className="text-slate-400 hover:text-slate-600"/></button>
                            </div>
                            <div className="space-y-3">
                                <div>
                                    <label className="block text-xs font-medium text-slate-500 mb-1">Nama Aktivitas</label>
                                    <input type="text" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={taskData.name} onChange={(e) => onChange('name', e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-slate-500 mb-1">Plan Start</label>
                                    <input type="date" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={taskData.planStart} onChange={(e) => onChange('planStart', e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-slate-500 mb-1">Plan End</label>
                                    <input type="date" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={taskData.planEnd} onChange={(e) => onChange('planEnd', e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-slate-500 mb-1">Lead Time (Hari)</label>
                                    <input type="number" className="w-full p-2 border border-slate-300 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={taskData.leadTime} onChange={(e) => onChange('leadTime', parseInt(e.target.value) || 0)} />
                                </div>
                            </div>
                            <div className="flex justify-end gap-3 mt-6">
                                <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Batal</button>
                                <button onClick={onSave} className="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-sm transition-colors">Simpan</button>
                            </div>
                        </div>
                    </div>
                );
            };

            if (!isClient) return null;

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20 relative">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
                        <div className="max-w-[1800px] mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-md">H</div>
                                    <div>
                                        <h1 className="text-lg font-bold tracking-tight text-slate-900 leading-none">WORLDWHITE ENTERPRISE</h1>
                                        <p className="text-[10px] text-slate-500 uppercase tracking-wider font-semibold mt-0.5">RAYA 2027 PLANNER</p>
                                    </div>
                                </div>
                                <nav className="flex space-x-1 bg-slate-100 p-1 rounded-lg">
                                    <button onClick={() => setActiveTab('dashboard')} className={`px-4 py-1.5 text-xs font-semibold rounded-md transition-all ${activeTab === 'dashboard' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Dashboard</button>
                                    <button onClick={() => setActiveTab('gantt')} className={`px-4 py-1.5 text-xs font-semibold rounded-md transition-all ${activeTab === 'gantt' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Gantt Chart</button>
                                    <button onClick={() => setActiveTab('activities')} className={`px-4 py-1.5 text-xs font-semibold rounded-md transition-all ${activeTab === 'activities' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Activities</button>
                                    <button onClick={() => setActiveTab('budgeting')} className={`px-4 py-1.5 text-xs font-semibold rounded-md transition-all flex items-center gap-1 ${activeTab === 'budgeting' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Icons.Wallet size={14}/> Budgeting</button>
                                    <button onClick={() => setActiveTab('pricing')} className={`px-4 py-1.5 text-xs font-semibold rounded-md transition-all flex items-center gap-1 ${activeTab === 'pricing' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Icons.Tag size={14}/> Pricing</button>
                                </nav>
                            </div>
                        </div>
                    </header>
                    <main className="max-w-[1900px] mx-auto px-4 sm:px-6 lg:px-8 py-6">
                        {activeTab === 'dashboard' && renderDashboard()}
                        {activeTab === 'gantt' && renderGantt()}
                        {activeTab === 'activities' && renderActivities()}
                        {activeTab === 'budgeting' && renderBudgeting()}
                        {activeTab === 'pricing' && renderPricing()}
                    </main>
                    <ConfirmationModal config={modalConfig} onConfirm={handleConfirm} onCancel={handleCancel} />
                    <EditTaskModal config={editModalConfig} onClose={closeEditActivity} onSave={saveEditActivity} onChange={handleEditFormChange} />
                    <AddTaskModal isOpen={addModalConfig.isOpen} onClose={closeAddActivity} onSave={handleSaveNewActivity} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
